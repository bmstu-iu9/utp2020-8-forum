<div class="selectedTheme colorMain">
    <h2 class="categoryHeader colorTextLight">{{postsListTitle}}</h2>
<div class="colorTextLight">
    {{#if posts}}
        <span><a id='byTime'
            {{#is sortTag 'byTime' }}
                 href="?sortTag=byTimeAsc"
            {{else}}
                {{#if sortTag }}
                 href="?sortTag=byTime"
                {{else}}
                 href="?sortTag=byTimeAsc"
                {{/if}}
            {{/is}}
                 class="sortLink">По времени <span class="sortLinkArrow" id="byTimeSortLink">&nbsp;</span></a></span>
        <span><a id='byReplies'
            {{#is sortTag 'byReplies' }}
                 href="?sortTag=byRepliesAsc"
            {{else}}
                 href="?sortTag=byReplies"
            {{/is}}
                 class="sortLink">По ответам <span class="sortLinkArrow" id="byRepliesSortLink">&nbsp;</span></a></span>
        <span><a id="byLastReply"
            {{#is sortTag 'byLastReply' }}
                 href="?sortTag=byLastReplyAsc"
            {{else}}
                 href="?sortTag=byLastReply"
            {{/is}}
                 class="sortLink">По последнему ответу <span class="sortLinkArrow"
                                                             id="byLastReplySortLink">&nbsp;</span></a></span></div>
        <ul id="ulPosts" class="noUlDefaultPadding noUlDecor">
            {{#each posts}}
                <li class="answer colorSection">
                    <div class="profile">
                        <img {{#if this.author_name}}
                        src="https://postal.ninja/assets/images/48981817022dda35bf548590be816d60-logo-100x100.png"
                        {{else}}
                        src="https://avatars.mds.yandex.net/get-znatoki/1368855/2a0000016cc1fb6175fa439bc6ab108427ae/w480"
                        {{/if}}
                        alt="No avatar" height="100" width="100">
                        {{#eq this.author_id ../user.id}}
                            <a class="profileName link colorDarkLink"
                               onclick="showPopup('editPostPopup'); editPost({{this.id}}, {{this.category_id}}, '{{this.title}}')">Edit</a>
                            <a class="profileName link colorDarkLink" onclick="deletePost({{this.id}})">Delete</a>
                        {{else}}
                            <div class="profileName link colorDarkLink">
                                {{#if this.author_name}}
                                    {{this.author_name}}
                                {{else}}
                                    Удален
                                {{/if}}
                            </div>
                        {{/eq}}
                    </div>

                    <a class="textAndTime link" href="/post/{{this.id}}?from={{../currentPath}}">
                    <span class="answerText  ColorTextDark">{{this.title}}</span>
                    <div class="timeLast">
                        {{this.time_since_creation}}
                    </div>
                    </a>
                    <div class="voteField">
                        <a href="/post/{{this.id}}?{{../currentPath}}"><input type="image"
                                                                              class="replyImage vote colorDarkLink myButton colorSection"
                                                                              src="/static/images/reply.png"
                                                                              alt="#"/></a>
                        <div class="voteCounter colorMain colorTextLight">
                            {{#if this.reply_count}}
                                {{this.reply_count}}
                            {{else}}
                                0
                            {{/if}}
                        </div>
                    </div>
                </li>
            {{/each}}
        </ul>
    {{else}}
        {{#if category}}
        <p class="colorTextLight">Нет постов.
            {{#if user}}
                <a onclick="showPopup('createPostPopup')" href="#">Создайте пост</a>
                или
                <form action="/category/delete/{{category}}" method="post">
                    <input type="submit" value="удалите категорию">
                </form>
                </p>
            {{else}}
                <p class="colorTextLight">Войдите или зарегистрируйтесь, чтобы создать пост</p>
            {{/if}}
        {{else}}
        <p class="colorTextLight">Нет постов
            {{#if user}}
                <a onclick="showPopup('createPostPopup')" href="#">Создайте пост</a>
            </p>
            {{else}}
                <p class="colorTextLight">Войдите или зарегистрируйтесь, чтобы создать пост</p>
            {{/if}}
        {{/if}}
    {{/if}}
</div>
<script>
    let box1 = document.getElementById('logInForm'), box2 = document.getElementById('signUpForm'),
            box3 = document.getElementById('postCreation'),
            box4 = document.getElementById('postChange');
    window.onclick = function (event) {
        if (event.target === box1) {
            box1.style.display = 'none';
        } else if (event.target === box2) {
            box2.style.display = 'none';
        } else if (event.target === box3) {
            box3.style.display = 'none';
        } else if (event.target === box4) {
            box4.style.display = 'none';
        }
    }

    const deletePost = (id) => {
        let post = {
            id: id
        };
        fetch('/post/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            body: JSON.stringify(post)
        }).then(() => {
            location.reload();
        });
    }
    const editPost = (id, category, text) => {
        document.getElementById('editPost').value = text;
        document.getElementById('sendEdition').onsubmit = async (e) => {
            e.preventDefault();
            let post = {
                id: id,
                category: category,
                text: document.getElementById('sendEdition').edition.value
            }
            fetch('/post/edit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                },
                body: JSON.stringify(post)
            }).then((res) => {
                if (res.ok) {
                    location.reload();
                } else {
                    location.href = '/category/myPosts?postFail=true`';
                }
            });
        };
    }
    if ('{{sortTag}}'.endsWith('Asc')) {
        const sortLinkId = '{{sortTag}}'.replace('Asc', '')
        document.getElementById(sortLinkId).classList.add('chosenSortLinkAsc');
        document.getElementById(sortLinkId + 'SortLink').innerHTML = "↑";
    } else {
        const sortLinkId = '{{sortTag}}';
        document.getElementById(sortLinkId).classList.add('chosenSortLink');
        document.getElementById(sortLinkId + 'SortLink').innerHTML = "↓";
    }
</script>
